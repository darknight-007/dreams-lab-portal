{% extends "quiz_base.html" %}

{% block quiz_title %}SES 598: Advanced Concepts Quiz{% endblock %}

{% block mcq_section_title %}
<div class="quiz-intro mb-4">
    <p class="text-muted" style="font-size: 0.95rem;">
        Test your foundation in robotics and AI concepts by completing this quiz. It helps assess if this course aligns with your interests. 
        A timestamped certificate of successful completion will be used to prioritize students if the course reaches capacity.
    </p>
    <hr class="my-4">
    <h5>Part 2: Advanced Concepts</h5>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .question {
        margin-bottom: 2rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #fff;
    }
    .options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .option {
        display: block;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .option:hover {
        background-color: #f8f9fa;
    }
    .progress {
        height: 1.5rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
    }
    .progress-bar {
        transition: width 0.6s ease;
    }
    .user-info {
        margin-bottom: 2rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    .answer-explanations {
        margin-top: 2rem;
    }
    .explanation {
        background-color: #f8f9fa;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 0.5rem;
        border-left: 4px solid #0d6efd;
    }
    .explanation h5 {
        color: #0d6efd;
        margin-bottom: 1rem;
    }
    .explanation ul {
        margin-top: 0.5rem;
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    .explanation li {
        margin-bottom: 0.5rem;
    }
    .tutorial-link {
        margin-top: 1rem;
    }
    .tutorial-link a {
        color: #0d6efd;
        text-decoration: none;
    }
    .tutorial-link a:hover {
        text-decoration: underline;
    }
    .success-message {
        background: #f0f7f0;
        border-radius: 4px;
        padding: 1.5rem;
        margin: 2rem 0;
        text-align: center;
    }
    .success-message h2 {
        color: #2c662d;
        margin: 0;
        font-size: 1.5rem;
    }
</style>
{% endblock %}

{% block mcq_questions %}
    {% if show_results %}
        <div class="mission-report">
            <div class="mission-header">
                <div class="mission-badge">
                    <i class="fas fa-satellite"></i>
                </div>
                <h2>Mission Control Report</h2>
                <p class="mission-id">Operator ID: {{ email }}</p>
            </div>

            <div class="telemetry-data">
                <div class="score-display">
                    <div class="score-ring" style="--score: {{ score }}">
                        <div class="score-value">{{ score|floatformat:1 }}%</div>
                        <div class="score-label">Mission Success Rate</div>
                    </div>
                </div>

                <div class="systems-check">
                    <h3><i class="fas fa-microchip"></i> Systems Analysis</h3>
                    <div class="systems-grid">
                        <div class="system-item {% if score >= 80 %}optimal{% elif score >= 60 %}nominal{% else %}critical{% endif %}">
                            <i class="fas fa-brain"></i>
                            <span>AI Systems</span>
                        </div>
                        <div class="system-item {% if score >= 80 %}optimal{% elif score >= 60 %}nominal{% else %}critical{% endif %}">
                            <i class="fas fa-robot"></i>
                            <span>Robotics Control</span>
                        </div>
                        <div class="system-item {% if score >= 80 %}optimal{% elif score >= 60 %}nominal{% else %}critical{% endif %}">
                            <i class="fas fa-camera"></i>
                            <span>Vision Systems</span>
                        </div>
                        <div class="system-item {% if score >= 80 %}optimal{% elif score >= 60 %}nominal{% else %}critical{% endif %}">
                            <i class="fas fa-project-diagram"></i>
                            <span>SLAM Operations</span>
                        </div>
                    </div>
                </div>

                {% if score >= 60 %}
                    <div class="mission-success">
                        {% csrf_token %}
                        <h3><i class="fas fa-check-circle"></i> Mission Status: ACCOMPLISHED</h3>
                        <div class="clearance-level">
                            {% if score >= 90 %}
                                <div class="clearance elite">
                                    <span class="badge">ELITE</span>
                                    <p>Outstanding performance! You've demonstrated exceptional mastery of the enrollment quiz concepts. You're well-prepared to begin the space robotics course.</p>
                                </div>
                            {% elif score >= 80 %}
                                <div class="clearance advanced">
                                    <span class="badge">ADVANCED</span>
                                    <p>Excellent work! Your understanding of the enrollment quiz concepts is strong. You're ready to start your journey in space robotics.</p>
                                </div>
                            {% else %}
                                <div class="clearance qualified">
                                    <span class="badge">QUALIFIED</span>
                                    <p>Enrollment quiz completed successfully! You've demonstrated sufficient understanding of the fundamental concepts to begin the course.</p>
                                </div>
                            {% endif %}
                        </div>
                        <div class="next-steps">
                            {% if eligible_for_certificate %}
                                <p class="completion-time" style="color: #4a9eff; font-family: monospace; margin-bottom: 1rem;">
                                    <i class="fas fa-clock"></i> Quiz completed on <span id="completionTime"></span>
                                </p>
                                <button onclick="generateCertificate()" class="certificate-button" id="certBtn">
                                    <i class="fas fa-certificate"></i> Download Enrollment Certificate
                                </button>
                            {% endif %}
                            <p>You've successfully completed the enrollment quiz. You can now proceed with course registration.</p>
                            <a href="https://registrar.asu.edu/register-for-classes" class="proceed-button" target="_blank">
                                <i class="fas fa-rocket"></i> Register for Course
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="mission-retry">
                        <h3><i class="fas fa-exclamation-triangle"></i> Mission Status: RECALIBRATION NEEDED</h3>
                        <p>Additional training recommended before proceeding with space operations.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <style>
            .mission-report {
                background: linear-gradient(135deg, #1a1a2e, #16213e);
                color: #e1e1e1;
                border-radius: 15px;
                padding: 2rem;
                margin: 2rem 0;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }

            .mission-header {
                text-align: center;
                margin-bottom: 2rem;
                position: relative;
            }

            .mission-badge {
                font-size: 3rem;
                color: #4a9eff;
                margin-bottom: 1rem;
            }

            .mission-id {
                color: #4a9eff;
                font-family: monospace;
                font-size: 1.1rem;
            }

            .score-display {
                text-align: center;
                margin: 2rem 0;
            }

            .score-ring {
                width: 200px;
                height: 200px;
                border-radius: 50%;
                margin: 0 auto;
                position: relative;
                background: conic-gradient(
                    #4a9eff calc(var(--score) * 1%),
                    #2a3950 calc(var(--score) * 1%)
                );
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
            }

            .score-ring::before {
                content: '';
                position: absolute;
                width: 160px;
                height: 160px;
                border-radius: 50%;
                background: #1a1a2e;
            }

            .score-value {
                font-size: 2.5rem;
                font-weight: bold;
                color: #4a9eff;
                position: relative;
                z-index: 1;
            }

            .score-label {
                font-size: 0.9rem;
                color: #8a8a9a;
                position: relative;
                z-index: 1;
            }

            .systems-check {
                background: rgba(255,255,255,0.05);
                border-radius: 10px;
                padding: 1.5rem;
                margin: 2rem 0;
            }

            .systems-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }

            .system-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 1rem;
                border-radius: 8px;
                background: rgba(255,255,255,0.03);
            }

            .system-item.optimal { color: #00ff9d; }
            .system-item.nominal { color: #ffb800; }
            .system-item.critical { color: #ff4444; }

            .clearance-level {
                margin: 2rem 0;
                padding: 1.5rem;
                border-radius: 10px;
                background: rgba(255,255,255,0.05);
            }

            .badge {
                display: inline-block;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: bold;
                margin-bottom: 1rem;
            }

            .clearance.elite .badge { background: #00ff9d; color: #1a1a2e; }
            .clearance.advanced .badge { background: #4a9eff; color: #1a1a2e; }
            .clearance.qualified .badge { background: #ffb800; color: #1a1a2e; }

            .certificate-button {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.8rem 1.5rem;
                border-radius: 25px;
                text-decoration: none;
                font-weight: bold;
                transition: transform 0.2s;
                margin: 0.5rem;
                background: linear-gradient(135deg, #ffd700, #ffa500);
                color: #1a1a2e;
                border: none;
                cursor: pointer;
            }

            .certificate-button:hover {
                transform: translateY(-2px);
            }

            .certificate-button:disabled {
                background: #666;
                cursor: not-allowed;
                transform: none;
            }

            .proceed-button, .retry-button, .review-button {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.8rem 1.5rem;
                border-radius: 25px;
                text-decoration: none;
                font-weight: bold;
                transition: transform 0.2s;
                margin: 0.5rem;
            }

            .proceed-button {
                background: linear-gradient(135deg, #00ff9d, #00b8ff);
                color: #1a1a2e;
            }

            .retry-button {
                background: #ff4444;
                color: white;
            }

            .review-button {
                background: #4a9eff;
                color: white;
            }

            .proceed-button:hover, .retry-button:hover, .review-button:hover {
                transform: translateY(-2px);
            }

            @media (max-width: 768px) {
                .systems-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <div id="answer-explanations" class="answer-explanations">
            <h4>Detailed Mission Analysis:</h4>
            <div class="answer-explanations">
                <div class="explanation">
                    <h5>1. Multi-view Geometry (Baseline)</h5>
                    <p>Correct Answer: 0.5 meters (balanced parallax and matching with good depth resolution)</p>
                    <p>Rationale: For a 35mm focal length camera at 10m distance:</p>
                    <ul>
                        <li>Depth Resolution Analysis:
                            <ul>
                                <li>Error ∝ Z²/(B×f) where Z=depth, B=baseline, f=focal length</li>
                                <li>With f=35mm, Z=10m, B=0.5m gives practical resolution</li>
                                <li>Larger baselines improve resolution but complicate matching</li>
                            </ul>
                        </li>
                        <li>Feature Matching Considerations:
                            <ul>
                                <li>0.2m: Too small, poor depth resolution despite easy matching</li>
                                <li>0.5m: Optimal balance (about 1/20 of depth)</li>
                                <li>1.0m: Matching becomes difficult due to perspective changes</li>
                                <li>2.0m: Excessive, feature matching highly unreliable</li>
                            </ul>
                        </li>
                        <li>Practical Constraints:
                            <ul>
                                <li>Field of view overlap must be maintained</li>
                                <li>Feature appearance changes with baseline</li>
                                <li>Triangulation accuracy vs. matching reliability trade-off</li>
                            </ul>
                        </li>
                    </ul>
                    <p>Common misconception: While larger baselines mathematically improve depth resolution, practical stereo systems are limited by feature matching reliability. The optimal baseline must balance these competing factors.</p>
                </div>

                <div class="explanation">
                    <h5>2. SLAM Loop Closure</h5>
                    <p>Correct Answer: To reduce accumulated drift by recognizing previously visited locations (global consistency)</p>
                    <p>Rationale: Loop closure is fundamental to robust SLAM because:</p>
                    <ul>
                        <li>Error Accumulation:
                            <ul>
                                <li>Wheel odometry drifts over time (wheel slip, uneven terrain)</li>
                                <li>IMU integration accumulates errors</li>
                                <li>Visual odometry can have scale drift</li>
                            </ul>
                        </li>
                        <li>Global Consistency:
                            <ul>
                                <li>Recognizing revisited locations provides absolute references</li>
                                <li>Allows correction of accumulated drift</li>
                                <li>Enables creation of globally consistent maps</li>
                            </ul>
                        </li>
                        <li>Common Misconceptions:
                            <ul>
                                <li>Moving object detection is important but handled separately</li>
                                <li>Path planning uses the map but isn't part of SLAM</li>
                                <li>Sensor calibration is a prerequisite, not a SLAM function</li>
                            </ul>
                        </li>
                    </ul>
                    <p>Real-world impact: Without loop closure, a robot might create multiple inconsistent maps of the same location, leading to navigation failures.</p>
                </div>

                <div class="explanation">
                    <h5>3. Kalman Filter Parameters</h5>
                    <p>Correct Answer: High process noise, high measurement noise (conservative estimation)</p>
                    <p>Rationale: For fast-moving robots, both noise parameters need careful consideration:</p>
                    <ul>
                        <li>High process noise is needed because:
                            <ul>
                                <li>Robot state changes rapidly and may be unpredictable</li>
                                <li>Dynamic model might not capture all motion complexities</li>
                                <li>Acceleration and deceleration effects are significant</li>
                            </ul>
                        </li>
                        <li>High measurement noise is also necessary because:
                            <ul>
                                <li>Sensors suffer from motion blur and vibrations</li>
                                <li>Rapid movement can reduce sensor reliability</li>
                                <li>Environmental factors affect measurements more at speed</li>
                            </ul>
                        </li>
                        <li>This conservative approach:
                            <ul>
                                <li>Prevents overconfidence in both model and measurements</li>
                                <li>Provides more robust state estimation</li>
                                <li>Better handles the uncertainties in high-speed operation</li>
                            </ul>
                        </li>
                    </ul>
                    <p>Common misconception: Trusting sensors more (low measurement noise) might seem intuitive for quick updates, but sensor reliability actually decreases with speed.</p>
                </div>

                <div class="explanation">
                    <h5>4. Sampling Strategy</h5>
                    <p>Correct Answer: Information gain-based sampling (adaptive and efficient)</p>
                    <p>Rationale: In resource-constrained exploration:</p>
                    <ul>
                        <li>Strategy Comparison:
                            <ul>
                                <li>Random: Simple but wastes resources on already-known areas</li>
                                <li>Grid-based: Systematic but rigid coverage</li>
                                <li>Information gain: Adapts to findings and uncertainty</li>
                                <li>Uniform: Predictable but ignores environment structure</li>
                            </ul>
                        </li>
                        <li>Information Gain Benefits:
                            <ul>
                                <li>Prioritizes high-uncertainty regions</li>
                                <li>Adapts sampling density to information content</li>
                                <li>Optimizes resource usage (energy, time, memory)</li>
                            </ul>
                        </li>
                        <li>Practical Applications:
                            <ul>
                                <li>Planetary rovers choosing sampling locations</li>
                                <li>Environmental monitoring with limited sensors</li>
                                <li>Search and rescue operations</li>
                            </ul>
                        </li>
                    </ul>
                    <p>Common misconception: While random sampling ensures unbiased coverage, it's inefficient for resource-limited scenarios where intelligent decision-making is crucial.</p>
                </div>

                <div class="explanation">
                    <h5>5. Error Types in Rock Mapping</h5>
                    <p>Correct Answer: Type I Error (False Positives) - wasting resources on wrong samples is more costly</p>
                    <p>Rationale: In resource-constrained planetary exploration:</p>
                    <ul>
                        <li>Cost Analysis:
                            <ul>
                                <li>Sample collection requires significant energy and time</li>
                                <li>Storage capacity for samples is extremely limited</li>
                                <li>Each false positive wastes irreplaceable resources</li>
                            </ul>
                        </li>
                        <li>Mission Impact:
                            <ul>
                                <li>False positives lead to wasted collection attempts</li>
                                <li>Storage space filled with non-target samples</li>
                                <li>Opportunity cost of missing better samples later</li>
                            </ul>
                        </li>
                        <li>Trade-off Considerations:
                            <ul>
                                <li>While missing targets (Type II) is undesirable, more targets can be found later</li>
                                <li>Resources wasted on false positives (Type I) cannot be recovered</li>
                                <li>Conservative identification preserves resources for high-confidence targets</li>
                            </ul>
                        </li>
                    </ul>
                    <p>Common misconception: While finding all potential targets seems important, in resource-constrained scenarios, avoiding resource waste on false positives takes precedence over catching every possible target.</p>
                </div>
            </div>
        </div>
    {% else %}
        <form method="post" id="quizForm">
            {% csrf_token %}
            <div class="user-info">
                <h4>Student Information</h4>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" class="form-control" id="email" name="email" 
                           value="{{ email }}" {% if email and email != 'Anonymous' %}readonly{% endif %}
                           placeholder="username@asu.edu">
                    {% if email and email != 'Anonymous' %}
                        <small class="text-muted">Email carried over from Part 1</small>
                    {% endif %}
                </div>
            </div>

            <div class="question">
                <h3>1. In the multi-view geometry tutorial with a 35mm focal length camera observing a rock formation at 10 meters, what baseline setting provides the best balance between feature matching confidence and depth estimation accuracy?</h3>
                <p class="question-context">Consider the following factors in the tutorial widget:</p>
                <ul class="question-hints">
                    <li>Depth resolution (proportional to baseline × focal_length / distance²)</li>
                    <li>Feature matching reliability (decreases with larger baseline)</li>
                    <li>Field of view overlap between cameras</li>
                    <li>Triangulation geometry</li>
                </ul>
                <div class="options">
                    <label class="option"><input type="radio" name="q1" value="1" required> 0.2 meters (minimal parallax, easy matching but poor depth resolution)</label>
                    <label class="option"><input type="radio" name="q1" value="2"> 0.5 meters (balanced parallax and matching with good depth resolution)</label>
                    <label class="option"><input type="radio" name="q1" value="3"> 1.0 meters (strong depth resolution but challenging feature matching)</label>
                    <label class="option"><input type="radio" name="q1" value="4"> 2.0 meters (optimal depth resolution but impractical for feature matching)</label>
                    <label class="option"><input type="radio" name="q1" value="0"> I am not sure</label>
                </div>
                <p class="tutorial-link mt-2">
                    <a href="{% url 'multiview_geometry' %}" target="_blank">Open Multi-view Geometry Tutorial ↗</a>
                </p>
            </div>

            <div class="question">
                <h3>2. In SLAM, what is the primary purpose of loop closure detection?</h3>
                <p class="question-context">Consider the challenges in long-term robot navigation:</p>
                <ul class="question-hints">
                    <li>Accumulation of odometry errors over time</li>
                    <li>Integration of multiple sensor measurements</li>
                    <li>Maintaining global map consistency</li>
                </ul>
                <div class="options">
                    <label class="option"><input type="radio" name="q2" value="1" required> To detect moving objects (dynamic environment handling)</label>
                    <label class="option"><input type="radio" name="q2" value="2"> To reduce accumulated drift by recognizing previously visited locations (global consistency)</label>
                    <label class="option"><input type="radio" name="q2" value="3"> To plan the shortest path (navigation optimization)</label>
                    <label class="option"><input type="radio" name="q2" value="4"> To calibrate sensors (hardware optimization)</label>
                    <label class="option"><input type="radio" name="q2" value="0"> I am not sure</label>
                </div>
            </div>

            <div class="question">
                <h3>3. For a fast-moving robot using sensor fusion with a Kalman filter, which noise parameter configuration would provide the most robust state estimation?</h3>
                <p class="question-context">Consider the trade-offs between:</p>
                <ul class="question-hints">
                    <li>Motion-induced sensor noise (vibrations, blur)</li>
                    <li>Rapid state changes in dynamics</li>
                    <li>Sensor measurement reliability at speed</li>
                </ul>
                <div class="options">
                    <label class="option"><input type="radio" name="q3" value="1" required> Low process noise, high measurement noise (trust model more than sensors)</label>
                    <label class="option"><input type="radio" name="q3" value="2"> High process noise, low measurement noise (trust sensors more than model)</label>
                    <label class="option"><input type="radio" name="q3" value="3"> High process noise, high measurement noise (conservative estimation)</label>
                    <label class="option"><input type="radio" name="q3" value="4"> Low process noise, low measurement noise (aggressive estimation)</label>
                    <label class="option"><input type="radio" name="q3" value="0"> I am not sure</label>
                </div>
            </div>

            <div class="question">
                <h3>4. Which sampling strategy is most efficient for exploring an unknown environment with limited resources?</h3>
                <p class="question-context">Consider a planetary exploration scenario with constraints:</p>
                <ul class="question-hints">
                    <li>Limited battery/computation power</li>
                    <li>Unknown environment structure</li>
                    <li>Need to maximize information gain</li>
                    <li>Trade-off between exploration and exploitation</li>
                </ul>
                <div class="options">
                    <label class="option"><input type="radio" name="q4" value="1" required> Random sampling (unbiased but inefficient coverage)</label>
                    <label class="option"><input type="radio" name="q4" value="2"> Grid-based sampling (systematic but rigid coverage)</label>
                    <label class="option"><input type="radio" name="q4" value="3"> Information gain-based sampling (adaptive and efficient)</label>
                    <label class="option"><input type="radio" name="q4" value="4"> Uniform sampling (consistent but inflexible coverage)</label>
                    <label class="option"><input type="radio" name="q4" value="0"> I am not sure</label>
                </div>
            </div>

            <div class="question">
                <h3>5. In automated rock mapping for planetary exploration, which error type would be more critical to minimize when identifying potential sample collection sites?</h3>
                <p class="question-context">Consider a Mars rover scenario where:</p>
                <ul class="question-hints">
                    <li>Resources for sample collection are limited</li>
                    <li>Each sample collection attempt is costly</li>
                    <li>Mission success depends on collecting specific rock types</li>
                    <li>Type I Error (False Positive): Incorrectly identifying a non-target rock as target</li>
                    <li>Type II Error (False Negative): Missing a target rock by classifying it as non-target</li>
                </ul>
                <div class="options">
                    <label class="option"><input type="radio" name="q5" value="1" required> Type I Error (False Positives) - wasting resources on wrong samples is more costly</label>
                    <label class="option"><input type="radio" name="q5" value="2"> Type II Error (False Negatives) - missing potential discoveries is more costly</label>
                    <label class="option"><input type="radio" name="q5" value="3"> Both errors are equally important to minimize</label>
                    <label class="option"><input type="radio" name="q5" value="4"> Neither error matters as long as some samples are collected</label>
                    <label class="option"><input type="radio" name="q5" value="0"> I am not sure</label>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary" id="submitBtn">Submit Quiz</button>
            </div>
        </form>
    {% endif %}

    {% if score >= 70 %}
        <div class="success-message">
            <h2>Congratulations! You've passed Part 2</h2>
        </div>
    {% elif show_results %}
        <div class="alert alert-warning">
            <h5>Quiz Results</h5>
            <p>Your score indicates that some foundational concepts may need strengthening. However, if you believe you have the necessary background and experience in robotics and AI, please:</p>
            <ul>
                <li>Contact the instructor at jdas5@asu.edu to discuss your background and experience, or</li>
                <li>Attend the first day of class (if the course is not at capacity) to evaluate if the course aligns with your preparation</li>
            </ul>
            <p class="text-muted mt-2">The instructor can help assess if your practical experience or other coursework provides equivalent preparation for the advanced topics covered in this course.</p>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Add completion time display
document.addEventListener('DOMContentLoaded', function() {
    const timeElement = document.getElementById('completionTime');
    if (timeElement) {
        const now = new Date();
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZoneName: 'short'
        };
        timeElement.textContent = now.toLocaleString(undefined, options);
    }
});

function generateCertificate() {
    const button = document.getElementById('certBtn');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Certificate...';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    fetch('{% url "generate_certificate" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Certificate generation failed');
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'SES598_Certificate.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        button.innerHTML = '<i class="fas fa-check"></i> Certificate Generated!';
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to Generate';
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    });
}
</script>
{% endblock %}

{% block interactive_section %}{% endblock %} 