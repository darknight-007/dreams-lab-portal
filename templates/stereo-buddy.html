<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stereo Camera Configurator</title>
    <style>
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin: 20px 0;
        }

        .loading-text {
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #ccc;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <style>
        .container button {
            font-size: 20px;
            font-weight: bold;
            padding: 15px 30px;
            color: #fff;
            background-color: #007bff; /* Attractive blue color */
            border: none;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            cursor: pointer;
            transition: all 0.3s ease; /* Smooth transition for hover effect */
        }

        .container button:hover {
            background-color: #0056b3; /* Darker blue on hover */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); /* Stronger shadow on hover */
            transform: translateY(-2px); /* Slight lift on hover */
        }

        .container button:active {
            transform: translateY(0); /* Reset lift when clicked */
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1); /* Reduce shadow when clicked */
        }
    </style>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            height: 100vh;
        }

        .column {
            flex: 1;
            margin: 10px;
            display: flex;
            flex-direction: column;
        }

        .widget {
            max-width: 100%;
            overflow-y: auto;
        }

        .svg-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        svg {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
        }

        .results {
            margin-top: 20px;
        }

        .results div {
            margin-bottom: 10px;
        }

        .container {
            margin-bottom: 15px;
        }

        label span {
            font-weight: bold;
            margin-left: 5px;
        }

        input[type="number"] {
            width: 100px;
        }
    </style>
    <style>
    .container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .container label {
        flex: 1; /* Label takes a fixed amount of space */
        margin-right: 10px;
        font-size: 14px;
        font-weight: bold;
    }

    .container input[type="range"] {
        flex: 2; /* Slider takes more space */
        margin-right: 10px;
    }

    .container input[type="number"] {
        flex: 1; /* Number input takes a smaller space */
        width: 60px; /* Fixed width for stable alignment */
    }
</style>
<style>
    .debug-container {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        font-family: monospace;
        font-size: 14px;
        max-height: 200px;
        overflow-y: auto;
    }

    #debugOutput {
        white-space: pre-wrap;
    }
</style>

</head>
<body>
<div class="column widget">
    <h1>Stereo Camera Configurator</h1>
    <div class="loading-container" id="loadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Computing...</div>
    </div>

    <div class="container">
    <label for="sensorWidth">Sensor Width (mm): <span id="sensorWidthLabel">8.44</span></label>
    <input type="range" id="sensorWidth" min="1" max="20" step="0.01" value="8.44" oninput="syncValues('sensorWidth')">
    <input type="number" id="sensorWidthValue" value="8.44" step="0.01" oninput="syncValues('sensorWidth')">
</div>

<div class="container">
    <label for="focalLength">Focal Length (mm): <span id="focalLengthLabel">19.71</span></label>
    <input type="range" id="focalLength" min="5" max="50" step="0.1" value="19.71" oninput="syncValues('focalLength')">
    <input type="number" id="focalLengthValue" value="19.71" step="0.1" oninput="syncValues('focalLength')">
</div>

<div class="container">
    <label for="fieldOfView">Field of View (°): <span id="fieldOfViewLabel">45.0</span></label>
    <input type="range" id="fieldOfView" min="10" max="120" step="0.01" value="45.0" oninput="syncValues('fieldOfView')">
    <input type="number" id="fieldOfViewValue" value="45.0" step="0.1" oninput="syncValues('fieldOfView')">
</div>

<div class="container">
    <label for="baseline">Baseline (mm): <span id="baselineLabel">240</span></label>
    <input type="range" id="baseline" min="50" max="500" step="0.1" value="240" oninput="syncValues('baseline')">
    <input type="number" id="baselineValue" value="240" step="1" oninput="syncValues('baseline')">
</div>

<div class="container">
    <label for="distance">Distance to Object (z) (m): <span id="distanceLabel">5</span></label>
    <input type="range" id="distance" min="0.5" max="50" step="0.01" value="5" oninput="syncValues('distance')">
    <input type="number" id="distanceValue" value="5" step="0.1" oninput="syncValues('distance')">
</div>

<div class="container">
    <label for="toeInAngle">Toe-in Angle (°): <span id="toeInAngleLabel">0</span></label>
    <input type="range" id="toeInAngle" min="-45" max="45" step="0.001" value="0" oninput="syncValues('toeInAngle')">
    <input type="number" id="toeInAngleValue" value="0" step="0.1" oninput="syncValues('toeInAngle')">
</div>

    <div class="container">
        <button onclick="runBlender()">Render Blender Digital Twin Results</button>
    </div>

    <div class="results">
        <h2>Calculated Results</h2>
        <div id="focalLengthPixels">Focal Length (px): 0.0</div>
        <div id="disparity">Disparity: 0.0 px</div>
        <div id="zmin">Minimum Depth Resolution (zmin): 0.0 m</div>
        <div id="zmax">Maximum Depth Resolution (zmax): 0.0 m</div>
    </div>
    <div class="rendered_images">
        <h2>Rendered Images</h2>

    </div>
</div>

<div class="column svg-container">
    <h1>2D Camera Setup Visualization</h1>
    <svg id="cameraView" preserveAspectRatio="xMidYMid meet">
        <!-- Axis lines -->
        <line id="xAxis" stroke="black" stroke-width="2" />
        <line id="yAxis" stroke="black" stroke-width="2" />
        <!-- Axis labels -->
        <text id="xAxisLabel" text-anchor="middle" font-size="12"></text>
        <text id="yAxisLabel" text-anchor="middle" font-size="12"></text>
        <!-- Camera setup -->
        <polygon id="leftCameraFOV" fill="rgba(255, 0, 0, 0.6)"></polygon>
        <polygon id="rightCameraFOV" fill="rgba(0, 255, 0, 0.6)"></polygon>
        <line id="baselineLine" stroke="black" stroke-width="2" />
        <!-- Converging lines to object -->
        <line id="leftLineToObject" stroke="blue" stroke-width="2" />
        <line id="rightLineToObject" stroke="blue" stroke-width="2" />
        <!-- Object point -->
        <circle id="objectPoint" r="5" fill="black" />
    </svg>
</div>

<div class="container">
    <label for="rockModel">Select Rock Model:</label>
    <select id="rockModel">
        <!-- Dynamically populate with available models -->
    </select>
</div>
<div class="debug-container">
    <h2>Debug Messages</h2>
    <div id="debugOutput"></div>
</div>
<div class="rendered_files" id="renderedFiles" style="display: none;">
    <h2>Download Generated Files</h2>
    <div>
        <a id="blendFileLink" href="#" download="scene.blend">
            <button>Download Blender Scene (.blend)</button>
        </a>
    </div>
    <div>
        <a id="worldFileLink" href="#" download="scene.world">
            <button>Download Gazebo World (.world)</button>
        </a>
    </div>
</div>

<script>
   async function loadModels() {
    const response = await fetch("/get_models/");
    const models = await response.json();

    const dropdown = document.getElementById("rockModel");
    dropdown.innerHTML = ""; // Clear previous options
    models.forEach(model => {
        const option = document.createElement("option");
        option.value = model.path;  // Store relative path
        option.textContent = model.name;  // Display name
        dropdown.appendChild(option);
    });
}

   async function runBlender() {
    document.getElementById("loadingIndicator").style.display = "flex"; // Show loading spinner

    const dropdown = document.getElementById("rockModel");
    const selectedModel = dropdown.options[dropdown.selectedIndex].value; // Correctly fetch selected model

    // Debug message
    const debugDiv = document.getElementById("debugOutput");
    debugDiv.textContent = `Selected model: ${selectedModel}`; // Update the debug div

    const data = {
        sensorWidth: parseFloat(document.getElementById("sensorWidth").value),
        focalLength: parseFloat(document.getElementById("focalLength").value),
        baseline: parseFloat(document.getElementById("baseline").value),
        distance: parseFloat(document.getElementById("distance").value),
        toeInAngle: parseFloat(document.getElementById("toeInAngle").value),
        selectedModel: selectedModel, // Include selected model path
        modelPath: selectedModel,
    };

    try {
        const response = await fetch("/run_blender/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });

        const result = await response.json();

       if (result.status === "success") {
    debugDiv.textContent += `\nBlender script executed successfully.`;
// Clear previous images and debug messages
document.querySelector(".rendered_images").innerHTML = ""; // Clear rendered images
debugDiv.textContent = ""; // Clear debug messages

    // Rendered Images
    document.querySelector(".rendered_images").innerHTML += `
        <div>
            <img src="/media/render_outputs/left_camera.png" alt="Left Image" width="300" />
            <img src="/media/render_outputs/right_camera.png" alt="Right Image" width="300" />
        </div>
        <div>
            <img src="/media/render_outputs/depth_map.png" alt="Disparity Map" width="300" />
            <img src="/media/render_outputs/disparity_map.png" alt="Depth Map" width="300" />
        </div>`;

    // Download Links for .blend and .world files
    const blendFilePath = "/media/render_outputs/scene.blend"; // Replace with actual server path
    const worldFilePath = "/media/render_outputs/scene.world"; // Replace with actual server path

    document.getElementById("blendFileLink").href = blendFilePath;
    document.getElementById("worldFileLink").href = worldFilePath;

    document.getElementById("renderedFiles").style.display = "block"; // Show the download links
}
else {
            debugDiv.textContent += `\nError: ${result.details}`;
        }
    } catch (error) {
        debugDiv.textContent += `\nError executing Blender script: ${error}`;
    } finally {
        document.getElementById("loadingIndicator").style.display = "none"; // Hide loading spinner
    }
}




    loadModels();
</script>

<script>
    const scalingFactor = 50;

    function syncValues(id) {
        const range = document.getElementById(id);
        const number = document.getElementById(id + 'Value');
        number.value = range.value;
        updateLabel(id);

        if (id === 'focalLength' || id === 'fieldOfView') {
            updateDependentValues(id);
        }
        updateValues();
    }

    function updateLabel(id) {
        const value = document.getElementById(id).value;
        document.getElementById(`${id}Label`).textContent = value;
    }

    function updateDependentValues(changedId) {
        const sensorWidth = parseFloat(document.getElementById('sensorWidth').value);

        if (changedId === 'focalLength') {
            const focalLength = parseFloat(document.getElementById('focalLength').value);
            const fieldOfView = (2 * Math.atan(sensorWidth / (2 * focalLength)) * 180) / Math.PI;
            document.getElementById('fieldOfView').value = fieldOfView.toFixed(1);
            document.getElementById('fieldOfViewValue').value = fieldOfView.toFixed(1);
        } else if (changedId === 'fieldOfView') {
            const fieldOfView = parseFloat(document.getElementById('fieldOfView').value);
            const focalLength = sensorWidth / (2 * Math.tan((fieldOfView * Math.PI) / 360));
            document.getElementById('focalLength').value = focalLength.toFixed(2);
            document.getElementById('focalLengthValue').value = focalLength.toFixed(2);
        }
    }

    function updateValues() {
        const sensorWidth = parseFloat(document.getElementById('sensorWidth').value);
        const focalLength = parseFloat(document.getElementById('focalLength').value);
        const baseline = parseFloat(document.getElementById('baseline').value) / 1000; // mm to meters
        const distance = parseFloat(document.getElementById('distance').value);
        const fieldOfView = parseFloat(document.getElementById('fieldOfView').value);
        const toeInAngle = parseFloat(document.getElementById('toeInAngle').value) * (Math.PI / 180); // Convert to radians
        const resolutionHorizontal = 2448; // Example resolution

        // Focal length in pixels
        const focalLengthPixels = focalLength * resolutionHorizontal / sensorWidth;

        // Minimum Depth Resolution (zmin)
        const zmin = baseline / (2 * Math.tan(toeInAngle + (fieldOfView * Math.PI / 360)));

        // Disparity
        const disparity = (focalLengthPixels * baseline) / (distance * Math.cos(toeInAngle));

        // Maximum Depth Resolution (zmax)
        const theta = 175e-6; // Pixel angular resolution in radians
        const zmax = baseline / (theta * Math.cos(toeInAngle));

        // Update the results in the UI
        document.getElementById('focalLengthPixels').textContent = `Focal Length (px): ${focalLengthPixels.toFixed(2)}`;
        document.getElementById('disparity').textContent = `Disparity: ${disparity.toFixed(2)} px`;
        document.getElementById('zmin').textContent = `Minimum Depth Resolution (zmin): ${zmin.toFixed(2)} m`;
        document.getElementById('zmax').textContent = `Maximum Depth Resolution (zmax): ${zmax.toFixed(2)} m`;

        // Update visualization
        updateSvg(baseline, distance, fieldOfView, toeInAngle);
    }


  function updateSvg(baseline, distance, fieldOfView, toeInAngle) {
    const svg = document.getElementById("cameraView");
    const scalingFactor = 100; // 100 pixels = 1 meter
    const sideLength = distance * scalingFactor * 2; // Double distance for visualization padding

    // Adjust SVG size
    svg.setAttribute("viewBox", `-${sideLength / 2} -${sideLength / 2} ${sideLength} ${sideLength}`);
    svg.setAttribute("width", sideLength);
    svg.setAttribute("height", sideLength);

    const centerX = 0; // Center of the SVG (world origin)
    const centerY = 0;

    const baselinePixels = baseline * scalingFactor;
    const leftCameraX = -baselinePixels / 2;
    const rightCameraX = baselinePixels / 2;

    const distancePixels = distance * scalingFactor;
    const fovRadians = (fieldOfView * Math.PI) / 180;
    const fovHalfWidth = Math.tan(fovRadians / 2) * distancePixels;
    const toeInRadians = toeInAngle ;

    // Object position
    const objectX = centerX;
    const objectY = -distancePixels;

    // Adjust FOV points for toe-in angle
    const leftFOVPoints = `
        ${leftCameraX},${centerY}
        ${leftCameraX + Math.tan(toeInRadians) * distancePixels - fovHalfWidth},${-distancePixels}
        ${leftCameraX + Math.tan(toeInRadians) * distancePixels + fovHalfWidth},${-distancePixels}
    `;
    const rightFOVPoints = `
        ${rightCameraX},${centerY}
        ${rightCameraX - Math.tan(toeInRadians) * distancePixels - fovHalfWidth},${-distancePixels}
        ${rightCameraX - Math.tan(toeInRadians) * distancePixels + fovHalfWidth},${-distancePixels}
    `;

    // Draw FOV polygons
    document.getElementById("leftCameraFOV").setAttribute("points", leftFOVPoints);
    document.getElementById("rightCameraFOV").setAttribute("points", rightFOVPoints);

    // Draw baseline
    document.getElementById("baselineLine").setAttribute("x1", leftCameraX);
    document.getElementById("baselineLine").setAttribute("y1", centerY);
    document.getElementById("baselineLine").setAttribute("x2", rightCameraX);
    document.getElementById("baselineLine").setAttribute("y2", centerY);

    // Draw converging lines to the object
    document.getElementById("leftLineToObject").setAttribute("x1", leftCameraX);
    document.getElementById("leftLineToObject").setAttribute("y1", centerY);
    document.getElementById("leftLineToObject").setAttribute("x2", objectX);
    document.getElementById("leftLineToObject").setAttribute("y2", objectY);

    document.getElementById("rightLineToObject").setAttribute("x1", rightCameraX);
    document.getElementById("rightLineToObject").setAttribute("y1", centerY);
    document.getElementById("rightLineToObject").setAttribute("x2", objectX);
    document.getElementById("rightLineToObject").setAttribute("y2", objectY);

    // Draw object point
    document.getElementById("objectPoint").setAttribute("cx", objectX);
    document.getElementById("objectPoint").setAttribute("cy", objectY);

    // Draw axes
    document.getElementById("xAxis").setAttribute("x1", -sideLength / 2);
    document.getElementById("xAxis").setAttribute("y1", 0);
    document.getElementById("xAxis").setAttribute("x2", sideLength / 2);
    document.getElementById("xAxis").setAttribute("y2", 0);

    document.getElementById("yAxis").setAttribute("x1", 0);
    document.getElementById("yAxis").setAttribute("y1", -sideLength / 2);
    document.getElementById("yAxis").setAttribute("x2", 0);
    document.getElementById("yAxis").setAttribute("y2", sideLength / 2);

    // Add axis labels
    document.getElementById("xAxisLabel").setAttribute("x", sideLength / 2 - 40);
    document.getElementById("xAxisLabel").setAttribute("y", 20);
    document.getElementById("xAxisLabel").textContent = "X (m)";

    document.getElementById("yAxisLabel").setAttribute("x", -20);
    document.getElementById("yAxisLabel").setAttribute("y", -sideLength / 2 + 20);
    document.getElementById("yAxisLabel").textContent = "Y (m)";
}



    updateValues();
</script>
</body>
</html>
